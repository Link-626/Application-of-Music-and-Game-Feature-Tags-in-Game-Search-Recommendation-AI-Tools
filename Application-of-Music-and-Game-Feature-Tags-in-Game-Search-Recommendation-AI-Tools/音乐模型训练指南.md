# 🎵 音乐风格分类模型训练完整指南

## 📋 概述

这个项目使用深度学习（PyTorch）来分类音乐风格，然后基于分类结果推荐相应的Steam游戏。模型支持8种音乐风格：电子、摇滚、古典、环境、流行、爵士、嘻哈、民谣。

## 📁 模型文件存储位置

所有模型文件都保存在 `data/` 目录中：

```
data/
├── real_music_model.pth      # PyTorch模型权重文件
├── real_scaler.pkl           # 特征标准化器
├── real_label_encoder.pkl    # 标签编码器
├── real_model_config.json    # 模型配置文件
├── real_training_curves.png  # 训练曲线图 (PNG)
├── real_training_curves.jpg  # 训练曲线图 (JPG)
└── training_progress.jpg     # 实时训练监控图
```

## 🚀 训练步骤

### 第一步：环境准备

1. **确保依赖已安装**
   ```bash
   pip install torch torchvision torchaudio
   pip install librosa numpy scikit-learn matplotlib
   ```

2. **创建数据目录**
   ```bash
   mkdir data
   ```

### 第二步：运行训练脚本

使用Million Song Dataset真实数据训练：

```bash
python start_training.py
```

或者直接运行训练脚本：

```bash
python train_with_real_data.py
```

### 第三步：训练过程详解

#### 1. 数据生成
- 系统会自动生成合成训练数据
- 每种音乐风格生成200个样本
- 总共1600个训练样本（8种风格 × 200样本）

#### 2. 特征提取
模型使用64维特征向量，包括：
- **MFCC特征** (26维)：梅尔频率倒谱系数
- **频谱特征** (6维)：质心、带宽、衰减
- **时域特征** (4维)：零交叉率、RMS能量
- **色度特征** (24维)：音高分布
- **节拍特征** (1维)：BPM
- **统计特征** (3维)：各种特征的统计量

#### 3. 神经网络架构
```
输入层 (64维) 
    ↓
隐藏层1 (256个神经元) + BatchNorm + ReLU + Dropout(0.3)
    ↓
隐藏层2 (128个神经元) + BatchNorm + ReLU + Dropout(0.3)
    ↓
隐藏层3 (64个神经元) + BatchNorm + ReLU + Dropout(0.3)
    ↓
输出层 (8个神经元) - 对应8种音乐风格
```

#### 4. 训练参数
- **优化器**: Adam
- **学习率**: 0.001
- **损失函数**: CrossEntropyLoss
- **批次大小**: 32
- **训练轮数**: 100
- **学习率调度**: ReduceLROnPlateau

### 第四步：模型验证

训练完成后，系统会：
1. 保存模型文件到 `data/` 目录
2. 生成训练曲线图（PNG和JPG格式）
3. 生成实时训练监控图
4. 使用测试数据验证模型性能
5. 显示分类结果和置信度

### 📊 训练状态监控

训练过程中会生成以下图片：

1. **实时监控图** (`data/training_progress.jpg`)
   - 每10轮更新一次
   - 显示当前训练状态
   - 包含损失曲线、准确率、进度条

2. **最终训练曲线** (`data/real_training_curves.jpg`)
   - 训练完成后生成
   - 包含4个子图：损失曲线、准确率曲线、对比图、趋势图
   - 高分辨率，适合报告使用

## 🎯 音乐风格分类

模型支持以下8种音乐风格：

| 风格 | 英文 | 特征描述 | 推荐游戏类型 |
|------|------|----------|-------------|
| 电子音乐 | Electronic | 高节拍、合成器音色 | 科幻、未来主义游戏 |
| 摇滚音乐 | Rock | 强节奏、吉他音色 | 动作、竞技游戏 |
| 古典音乐 | Classical | 复杂和声、管弦乐 | 策略、艺术游戏 |
| 环境音乐 | Ambient | 舒缓、氛围音效 | 探索、冥想游戏 |
| 流行音乐 | Pop | 朗朗上口、商业风格 | 休闲、社交游戏 |
| 爵士音乐 | Jazz | 即兴、复杂和声 | 侦探、复古游戏 |
| 嘻哈音乐 | Hip-hop | 说唱、节拍强烈 | 街头、竞技游戏 |
| 民谣音乐 | Folk | 原声乐器、叙事性 | 冒险、生存游戏 |

## 🔧 自定义训练

### 修改训练参数

在 `train_music_model.py` 中修改：

```python
# 训练参数
epochs = 100        # 增加训练轮数提高精度
batch_size = 64     # 增加批次大小（需要更多内存）
learning_rate = 0.0005  # 降低学习率提高稳定性
```

### 添加真实数据

如果要使用真实音乐数据训练：

1. 准备音乐文件（MP3/WAV格式）
2. 修改 `generate_synthetic_data()` 方法
3. 使用 `AudioProcessor` 提取真实特征
4. 重新训练模型

## 📊 模型性能评估

训练完成后，查看以下指标：

1. **训练曲线图** (`data/training_curves.png`)
   - 训练损失曲线
   - 验证损失曲线
   - 验证准确率曲线

2. **模型文件大小**
   - `deep_style_model.pth`: 通常 100-500 KB
   - `deep_scaler.pkl`: 通常 1-5 KB
   - `deep_model_config.json`: 通常 1-2 KB

3. **分类准确率**
   - 目标：验证集准确率 > 85%
   - 如果准确率低，可以增加训练轮数或调整网络架构

## 🚨 常见问题解决

### 1. 内存不足
```python
# 减少批次大小
batch_size = 16  # 或更小
```

### 2. 训练时间过长
```python
# 减少训练轮数
epochs = 50  # 或更少
```

### 3. 模型不收敛
```python
# 降低学习率
learning_rate = 0.0001
```

### 4. 过拟合
```python
# 增加Dropout率
nn.Dropout(0.5)  # 在神经网络中
```

## 🎮 与游戏推荐系统集成

训练好的模型会自动集成到游戏推荐系统中：

1. **音频上传** → 特征提取
2. **风格分类** → 深度学习模型预测
3. **游戏匹配** → 基于风格标签匹配游戏
4. **推荐结果** → 显示3款匹配游戏

## 📈 模型优化建议

1. **数据增强**：添加更多真实音乐样本
2. **特征工程**：尝试更多音频特征
3. **网络架构**：实验不同的隐藏层配置
4. **集成学习**：结合多个模型的预测结果
5. **迁移学习**：使用预训练的音乐分类模型

## ✅ 训练完成检查清单

- [ ] `data/real_music_model.pth` 文件存在
- [ ] `data/real_scaler.pkl` 文件存在  
- [ ] `data/real_label_encoder.pkl` 文件存在
- [ ] `data/real_model_config.json` 文件存在
- [ ] `data/real_training_curves.jpg` 文件存在
- [ ] `data/training_progress.jpg` 文件存在
- [ ] 验证准确率 > 80%
- [ ] 测试分类功能正常
- [ ] 与游戏推荐系统集成正常